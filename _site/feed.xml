<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Alon Zakai</title>
    <description>Compiling to the Web, Emscripten, Binaryen, WebAssembly, etc.
</description>
    <link>http://kripken.github.com/blog/</link>
    <atom:link href="http://kripken.github.com/blog/feed.xml" rel="self" type="application/rss+xml"/>
    <pubDate>Fri, 13 Apr 2018 11:51:52 -0700</pubDate>
    <lastBuildDate>Fri, 13 Apr 2018 11:51:52 -0700</lastBuildDate>
    <generator>Jekyll v3.0.1</generator>
    
      <item>
        <title>A Silly Binaryen Optimization</title>
        <description>&lt;p&gt;The &lt;a href=&quot;https://github.com/WebAssembly/binaryen&quot;&gt;Binaryen&lt;/a&gt; optimizer compiles wasm to better (smaller, faster) wasm. A lot of the &lt;a href=&quot;https://github.com/WebAssembly/binaryen/tree/master/src/passes&quot;&gt;optimizations&lt;/a&gt; it has are very specific to WebAssembly, which is maybe not surprising since wasm is an ‘odd’ compiler target in many ways. So many of the optimization tricks are also odd!&lt;/p&gt;

&lt;p&gt;Here’s a tiny recent example: wasm encodes constant integers using signed LEB32. As a result, negative numbers are &lt;em&gt;slightly&lt;/em&gt; favored, sometimes taking one less bit. For example,&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-js&quot; data-lang=&quot;js&quot;&gt;&lt;span class=&quot;nx&quot;&gt;x&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;64&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;takes one more byte than&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-js&quot; data-lang=&quot;js&quot;&gt;&lt;span class=&quot;nx&quot;&gt;x&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;64&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;However, the same is not true for 65 or 63 or most other numbers -  this only happens on &lt;a href=&quot;https://github.com/WebAssembly/binaryen/blob/master/src/passes/OptimizeInstructions.cpp#L1143&quot;&gt;very specific powers of 2&lt;/a&gt;! The reason is because of how signed LEBs and &lt;a href=&quot;https://en.wikipedia.org/wiki/Two%27s_complement&quot;&gt;two’s complement&lt;/a&gt; work. As you can see on that Wikipedia page’s examples, in 3-bit integers, 2 is &lt;code class=&quot;highlighter-rouge&quot;&gt;010&lt;/code&gt; and -2 is &lt;code class=&quot;highlighter-rouge&quot;&gt;110&lt;/code&gt;. For 2, we must emit 3 bits in signed LEB format, since we must emit a sign bit, but for -2 we just need 2 bits. So signed values have an advantage on powers of two, and this actually matters when the extra bit for the positive integer causes an extra LEB byte to be emitted (each byte contains 7 bits of payload, so which powers matter can be computed from that).&lt;/p&gt;

&lt;p&gt;To keep things simple, maybe we can ignore the specific values where this matters and just always encode negative integers? That is,&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-js&quot; data-lang=&quot;js&quot;&gt;&lt;span class=&quot;nx&quot;&gt;x&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;c&lt;/span&gt;  &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt;  &lt;span class=&quot;nx&quot;&gt;x&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;nx&quot;&gt;x&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;c&lt;/span&gt;  &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt;  &lt;span class=&quot;nx&quot;&gt;x&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;for any positive integer &lt;code class=&quot;highlighter-rouge&quot;&gt;c&lt;/code&gt;? But this has a downside: on typical code, addition is much more common than subtraction, and positive integers are much more common than negative ones. So if we did this, we’d be shrinking &lt;code class=&quot;highlighter-rouge&quot;&gt;c&lt;/code&gt; by replacing it with &lt;code class=&quot;highlighter-rouge&quot;&gt;-c&lt;/code&gt; but we’d be making the code less compressible by replacing a lot of additions with subtractions (note that we aren’t replacing all the additions, since many are not on a constant). In fact, on real-world code the downside outweights the benefit here: we reduce uncompressed size by a little but increase compressed size.&lt;/p&gt;

&lt;p&gt;To avoid that problem, Binaryen only does this &lt;a href=&quot;https://github.com/WebAssembly/binaryen/blob/master/src/passes/OptimizeInstructions.cpp#L1143&quot;&gt;on constants where it actually matters&lt;/a&gt;. Most of those have an addition before them that we replace by a subtraction, so there is still a downside to compression, but it is outweighted by us saving a byte, which helps enough that we reduce both the uncompressed and compressed size.&lt;/p&gt;

&lt;p&gt;How much does this affect binary size? Here are the diffs on the size of &lt;code class=&quot;highlighter-rouge&quot;&gt;tanks.wasm&lt;/code&gt;&lt;/p&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt; &lt;/th&gt;
      &lt;th style=&quot;text-align: center&quot;&gt;uncompressed&lt;/th&gt;
      &lt;th style=&quot;text-align: center&quot;&gt;compressed&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;All integers&lt;/td&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;-2552&lt;/td&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;+11347&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Just where it matters&lt;/td&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;-2552&lt;/td&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;-544&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt; &lt;/td&gt;
      &lt;td style=&quot;text-align: center&quot;&gt; &lt;/td&gt;
      &lt;td style=&quot;text-align: center&quot;&gt; &lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;That file is around 10MB uncompressed, 3MB compressed, so overall the effect here is quite small. Still, many small optimizations can add up…&lt;/p&gt;

</description>
        <pubDate>Fri, 13 Apr 2018 10:52:56 -0700</pubDate>
        <link>http://kripken.github.com/blog/binaryen/2018/04/13/a-silly-optimization.html</link>
        <guid isPermaLink="true">http://kripken.github.com/blog/binaryen/2018/04/13/a-silly-optimization.html</guid>
        
        
        <category>binaryen</category>
        
      </item>
    
  </channel>
</rss>
